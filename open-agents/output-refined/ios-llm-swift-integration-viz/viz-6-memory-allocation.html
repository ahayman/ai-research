<!-- Visualization: Typical Memory Allocation During LLM Inference -->
<!-- Generated: 2025-12-22 -->
<!-- Type: pie-chart -->
<!-- Source: MLX documentation and profiling data -->

<figure class="data-viz" id="viz-6">
  <div class="viz-container" style="position: relative; width: 100%; max-width: 600px; margin: 0 auto;">
    <canvas id="chart-memory"></canvas>
  </div>
  <figcaption>
    <strong>Figure 6:</strong> Memory Allocation During LLM Inference - Understanding where your RAM goes
    <span class="viz-source">Source: MLX documentation and profiling data</span>
  </figcaption>
</figure>

<style>
.data-viz {
  margin: 2rem 0;
  padding: 1.5rem;
  background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
  border-radius: 12px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.05);
}
.data-viz figcaption {
  text-align: center;
  margin-top: 1rem;
  font-size: 0.95rem;
  color: #475569;
}
.viz-source {
  display: block;
  font-size: 0.8rem;
  color: #94a3b8;
  margin-top: 0.5rem;
}
.viz-container {
  padding: 1rem;
}
</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
<script>
(function() {
  Chart.register(ChartDataLabels);

  const ctx = document.getElementById('chart-memory').getContext('2d');

  new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: ['Model Weights', 'KV Cache', 'Activations', 'GPU Buffer Cache'],
      datasets: [{
        data: [65, 20, 10, 5],
        backgroundColor: [
          'rgba(59, 130, 246, 0.85)',   // blue
          'rgba(16, 185, 129, 0.85)',   // green
          'rgba(245, 158, 11, 0.85)',   // amber
          'rgba(139, 92, 246, 0.85)'    // purple
        ],
        borderColor: [
          'rgba(59, 130, 246, 1)',
          'rgba(16, 185, 129, 1)',
          'rgba(245, 158, 11, 1)',
          'rgba(139, 92, 246, 1)'
        ],
        borderWidth: 2,
        hoverOffset: 10
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      cutout: '55%',
      plugins: {
        title: {
          display: true,
          text: 'Memory Allocation During LLM Inference',
          font: { size: 18, weight: 'bold' },
          color: '#1e293b',
          padding: { bottom: 20 }
        },
        legend: {
          position: 'bottom',
          labels: {
            padding: 20,
            usePointStyle: true,
            pointStyle: 'circle',
            font: { size: 13 }
          }
        },
        tooltip: {
          enabled: true,
          backgroundColor: '#1e293b',
          titleFont: { size: 14, weight: 'bold' },
          bodyFont: { size: 13 },
          padding: 14,
          callbacks: {
            label: function(context) {
              const descriptions = {
                0: 'Quantized weights stored in memory',
                1: 'Cached attention keys & values',
                2: 'Intermediate computation results',
                3: 'Metal GPU working memory'
              };
              return [
                context.label + ': ' + context.raw + '%',
                descriptions[context.dataIndex]
              ];
            }
          }
        },
        datalabels: {
          color: 'white',
          font: {
            weight: 'bold',
            size: 14
          },
          formatter: function(value) {
            return value + '%';
          },
          display: function(context) {
            return context.dataset.data[context.dataIndex] > 8;
          }
        }
      }
    },
    plugins: [{
      afterDraw: function(chart) {
        const ctx = chart.ctx;
        const centerX = chart.chartArea.left + (chart.chartArea.right - chart.chartArea.left) / 2;
        const centerY = chart.chartArea.top + (chart.chartArea.bottom - chart.chartArea.top) / 2;

        ctx.save();
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';

        ctx.font = 'bold 28px sans-serif';
        ctx.fillStyle = '#1e293b';
        ctx.fillText('100%', centerX, centerY - 8);

        ctx.font = '12px sans-serif';
        ctx.fillStyle = '#64748b';
        ctx.fillText('Total RAM', centerX, centerY + 14);
        ctx.restore();
      }
    }]
  });
})();
</script>
